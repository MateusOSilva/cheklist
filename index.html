<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograma de Implantação de Portaria Remota</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .task-item:hover .delete-task-btn {
            opacity: 1;
        }
        .delete-task-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .task-item input:checked + span {
            text-decoration: line-through;
            color: #9ca3af;
        }
        .editable-field {
            cursor: text;
            padding: 4px 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        .editable-field:hover {
            background-color: #f9fafb;
        }
        .editable-field:focus {
            outline: none;
            background-color: #eef2ff;
            box-shadow: 0 0 0 2px #a5b4fc;
        }
        .locked-field {
            cursor: default;
            padding: 4px 8px;
        }
        .section-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .task-header {
            font-weight: 600;
            color: #4b5563;
            margin-top: 1.25rem;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }
        #loading-overlay, #password-modal, #delete-task-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }
        textarea {
            resize: vertical;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Tela de Carregamento -->
    <div id="loading-overlay">
        <div class="text-center">
            <svg class="animate-spin h-8 w-8 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-lg font-medium text-white">A carregar o seu cronograma...</p>
        </div>
    </div>
    
    <!-- Modal de Senha -->
    <div id="password-modal" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-4">
            <h3 id="password-modal-title" class="text-lg font-bold mb-4 text-gray-900">Ação Requer Senha</h3>
            <p id="password-modal-text" class="text-sm text-gray-600 mb-4">Por favor, digite a senha para continuar.</p>
            <div>
                <label for="password-input" class="block text-sm font-medium text-gray-700">Senha</label>
                <input type="password" id="password-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <p id="password-error" class="text-red-500 text-xs mt-1 hidden">Senha incorreta.</p>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancel-action-button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 text-sm font-medium">Cancelar</button>
                <button id="confirm-action-button" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão de Tarefa -->
    <div id="delete-task-modal" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-4">
            <h3 class="text-lg font-bold mb-4 text-gray-900">Confirmar Exclusão</h3>
            <p class="text-sm text-gray-600 mb-4">Tem a certeza que deseja apagar esta tarefa? Esta ação não pode ser desfeita.</p>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancel-delete-task-button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 text-sm font-medium">Cancelar</button>
                <button id="confirm-delete-task-button" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm font-medium">Apagar</button>
            </div>
        </div>
    </div>


    <div id="page-content" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
        <header class="text-center mb-10">
            <!-- Banner Inserido Aqui -->
            <div class="mb-8">
                <img id="logo-img" src="https://raw.githubusercontent.com/MateusOSilva/cheklist/main/MC3%20LOGO.jpg" alt="Logo Grupo MC3" class="w-full max-w-lg mx-auto" crossorigin="anonymous">
            </div>

            <!-- Títulos -->
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Cronograma de Implantação</h1>
            <h2 id="condominium-name" class="text-xl sm:text-2xl font-semibold text-blue-700 mt-2 mb-6 text-center">
                Carregando...
            </h2>
        </header>

        <!-- Link de Colaboração -->
        <div class="no-print mb-8 p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
            <h3 class="font-bold text-gray-800">Link de Partilha (Importante)</h3>
            <p class="text-sm text-gray-600 mt-1">Para colaborar em tempo real, **é obrigatório** partilhar o link completo abaixo.</p>
            <div class="mt-3 flex items-center">
                <input id="share-link-display" readonly class="p-2 bg-gray-100 rounded-l-md text-gray-800 font-mono text-xs break-all w-full border border-gray-300 focus:ring-0 focus:border-gray-300">
                <button id="copy-link-button" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-r-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Copiar</button>
            </div>
        </div>

        <!-- Barra de Progresso -->
        <div class="mb-10 p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
            <div class="flex justify-between items-center mb-1">
                <span class="text-base font-medium text-blue-700">Progresso Geral</span>
                <span class="text-sm font-medium text-blue-700" id="progress-percentage">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="progress-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-500"></div>
            </div>
             <!-- Botão Gerar PDF -->
            <div class="mt-4 text-center">
                <button id="generate-pdf-button" style="display: none;" class="no-print inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm6 10a.75.75 0 000-1.5H7.75a.75.75 0 000 1.5h2.5zm-2.25-2a.75.75 0 01.75-.75h4.5a.75.75 0 010 1.5h-4.5a.75.75 0 01-.75-.75zm0-2.5a.75.75 0 01.75-.75h4.5a.75.75 0 010 1.5h-4.5a.75.75 0 01-.75-.75z" clip-rule="evenodd" />
                    </svg>
                    Gerar Relatório PDF
                </button>
            </div>
        </div>

        <main id="checklist-container" class="space-y-8">
        </main>

        <footer class="no-print text-center mt-12 flex flex-col sm:flex-row items-center justify-center gap-4 sm:gap-8">
             <button id="new-checklist-button" class="px-5 py-2.5 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Criar Novo Cronograma</button>
             <button id="reset-button" class="text-sm text-gray-500 hover:text-red-600 font-medium">Apagar este Cronograma</button>
        </footer>
    </div>

    <script type="module">
        const { jsPDF } = window.jspdf;
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ===================================================================================
        // SUA CONFIGURAÇÃO DO FIREBASE ESTÁ AQUI
        // ===================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDTYf3YwhZE5_2MweCUex3bCUs0RWh0GRw",
            authDomain: "cronogramaremota.firebaseapp.com",
            projectId: "cronogramaremota",
            storageBucket: "cronogramaremota.firebasestorage.app",
            messagingSenderId: "799352182116",
            appId: "1:799352182116:web:83e474730e8685870e9671",
            measurementId: "G-XB8JZ229JX"
        };
        // ===================================================================================

        // Elementos da página
        const loadingOverlay = document.getElementById('loading-overlay');
        const container = document.getElementById('checklist-container');
        const progressBar = document.getElementById('progress-bar');
        const progressPercentage = document.getElementById('progress-percentage');
        const resetButton = document.getElementById('reset-button');
        const newChecklistButton = document.getElementById('new-checklist-button');
        const condominiumNameElement = document.getElementById('condominium-name');
        const pdfButton = document.getElementById('generate-pdf-button');
        
        // Elementos do Modal de Senha
        const passwordModal = document.getElementById('password-modal');
        const passwordModalTitle = document.getElementById('password-modal-title');
        const passwordModalText = document.getElementById('password-modal-text');
        const passwordInput = document.getElementById('password-input');
        const passwordError = document.getElementById('password-error');
        const cancelActionButton = document.getElementById('cancel-action-button');
        const confirmActionButton = document.getElementById('confirm-action-button');

        // Elementos do Modal de Exclusão de Tarefa
        const deleteTaskModal = document.getElementById('delete-task-modal');
        const cancelDeleteTaskButton = document.getElementById('cancel-delete-task-button');
        const confirmDeleteTaskButton = document.getElementById('confirm-delete-task-button');

        // Variáveis de estado
        let db, auth;
        const defaultCondominiumName = "Nome do Condomínio (Clique para editar)";
        let projectData = {
            condominiumName: defaultCondominiumName,
            checklist: []
        };
        let checklistDocRef;
        let unsubscribe;
        let passwordAction = null; // Guarda a ação a ser executada: 'delete' ou 'createNew'
        let taskToDelete = null; // Guarda os índices da tarefa a ser apagada { sectionIndex, taskIndex }

        const defaultChecklist = [
            {
                title: "Fase 1 – Planeamento Inicial",
                observations: "",
                completionDate: "",
                tasks: [
                    { type: 'header', text: 'Alinhamento Estratégico' },
                    { type: 'task', text: 'Reunião de Abertura com o Cliente.', checked: false },
                    { type: 'task', text: 'Entendimento detalhado das necessidades e expectativas.', checked: false },
                    { type: 'task', text: 'Apresentação da solução de portaria remota e cronograma.', checked: false },
                ]
            },
            {
                title: "Fase 2 – Avaliação Técnica e Proposta",
                observations: "",
                completionDate: "",
                tasks: [
                    { type: 'header', text: 'Vistoria Técnica de Infraestrutura' },
                    { type: 'task', text: 'Analisar infraestrutura de interfonia existente (analógica/digital).', checked: false },
                    { type: 'task', text: 'Verificar portões de pedestre (quantidade, tipo de abertura, fluxo).', checked: false },
                    { type: 'task', text: 'Verificar portões de veículo (quantidade, tipo de abertura, fluxo).', checked: false },
                    { type: 'task', text: 'Analisar existência e funcionamento de clausura de pedestres e veículos.', checked: false },
                    { type: 'task', text: 'Identificar necessidade de obras civis (alvenaria, serralheria).', checked: false },
                    { type: 'task', text: 'Verificar qualidade do link de internet (velocidade, estabilidade) e se há link de backup.', checked: false },
                    { type: 'task', text: 'Analisar pontos de energia e necessidade de nobreaks/baterias.', checked: false },
                    { type: 'task', text: 'Mapear e fotografar todos os pontos de acesso e locais de instalação.', checked: false },
                    { type: 'header', text: 'Definição do Escopo e Proposta' },
                    { type: 'task', text: 'Definir tipos e quantidade de equipamentos (leitores, câmaras, controladoras, etc.).', checked: false },
                    { type: 'task', text: 'Elaborar o relatório técnico da vistoria.', checked: false },
                    { type: 'task', text: 'Desenhar o layout de instalação (croqui).', checked: false },
                    { type: 'task', text: 'Elaborar orçamento e proposta comercial detalhada.', checked: false },
                ]
            },
            {
                title: "Fase 3 – Aprovação e Aquisição",
                observations: "",
                completionDate: "",
                tasks: [
                    { type: 'header', text: 'Aprovação Comercial' },
                    { type: 'task', text: 'Apresentar proposta e orçamento ao cliente.', checked: false },
                    { type: 'task', text: 'Aprovação da proposta e assinatura do contrato com o cliente.', checked: false },
                    { type: 'header', text: 'Aquisição de Materiais e Logística' },
                    { type: 'task', text: 'Orçamento e compra de equipamentos principais (controladoras, câmaras, leitores, etc.).', checked: false },
                    { type: 'task', text: 'Compra de cabeamento estruturado, conectores, canaletas e outros insumos.', checked: false },
                    { type: 'task', text: 'Conferência e armazenamento seguro dos materiais recebidos.', checked: false },
                    { type: 'task', text: 'Separar materiais por kit de instalação (setores ou áreas).', checked: false },
                ]
            },
            {
                title: "Fase 4 – Infraestrutura Física",
                observations: "",
                completionDate: "",
                tasks: [
                    { type: 'header', text: 'Rede' },
                    { type: 'task', text: 'Passagem de cabos de rede (CAT6 ou superior) para pontos de câmaras, leitores e interfones.', checked: false },
                    { type: 'task', text: 'Instalação de switches PoE com redundância.', checked: false },
                    { type: 'task', text: 'Organização e identificação de cabos.', checked: false },
                    { type: 'header', text: 'Energia' },
                    { type: 'task', text: 'Instalação de pontos de energia dedicados.', checked: false },
                    { type: 'task', text: 'Nobreaks e baterias estacionárias (para manter funcionamento em queda de energia).', checked: false },
                    { type: 'task', text: 'Aterramento e proteção contra surtos.', checked: false },
                    { type: 'header', text: 'Fixações' },
                    { type: 'task', text: 'Instalação de suportes para câmaras, totens para leitores, caixas de sobrepor/embutir.', checked: false }
                ]
            },
            {
                title: "Fase 5 – Instalação dos Equipamentos",
                observations: "",
                completionDate: "",
                tasks: [
                    { type: 'header', text: 'Controle de acesso' },
                    { type: 'task', text: 'Instalação dos leitores faciais / RFID / biométricos.', checked: false },
                    { type: 'task', text: 'Ligação com fechaduras, eletroímãs, motores de portão.', checked: false },
                    { type: 'task', text: 'Teste individual de acionamento.', checked: false },
                    { type: 'header', text: 'CFTV' },
                    { type: 'task', text: 'Fixação e alinhamento das câmaras.', checked: false },
                    { type: 'task', text: 'Conexão na rede.', checked: false },
                    { type: 'task', text: 'Teste de imagem e gravação.', checked: false },
                    { type: 'header', text: 'Interfonia IP' },
                    { type: 'task', text: 'Instalação dos módulos de chamada.', checked: false },
                    { type: 'task', text: 'Integração com software de portaria remota.', checked: false },
                    { type: 'header', text: 'Central de controlo' },
                    { type: 'task', text: 'Montagem do rack (switches, patch panels, DVR/NVR, roteadores).', checked: false },
                    { type: 'task', text: 'Organização dos cabos e identificação.', checked: false }
                ]
            },
            {
                title: "Fase 6 – Configuração e Integração",
                observations: "",
                completionDate: "",
                tasks: [
                    { type: 'header', text: 'Configuração de rede' },
                    { type: 'task', text: 'IP fixo para cada equipamento.', checked: false },
                    { type: 'task', text: 'VLANs e QoS para priorização de tráfego de vídeo e voz.', checked: false },
                    { type: 'task', text: 'Configuração de redundância de internet.', checked: false },
                    { type: 'header', text: 'Software' },
                    { type: 'task', text: 'Cadastro de utilizadores (moradores, prestadores).', checked: false },
                    { type: 'task', text: 'Programação de horários e regras de acesso.', checked: false },
                    { type: 'task', text: 'Integração com sistema de portaria remota.', checked: false },
                    { type: 'header', text: 'CFTV' },
                    { type: 'task', text: 'Ajuste de ângulos e resolução.', checked: false },
                    { type: 'task', text: 'Configuração de gravação contínua e deteção de movimento.', checked: false },
                    { type: 'task', text: 'Criação de grupos e permissões de visualização.', checked: false },
                    { type: 'header', text: 'Testes' },
                    { type: 'task', text: 'Testes de abertura remota.', checked: false },
                    { type: 'task', text: 'Simulação de falhas e verificação do backup de energia.', checked: false },
                    { type: 'task', text: 'Ajustes finais.', checked: false }
                ]
            },
            {
                title: "Fase 7 – Treinamento e Entrega",
                observations: "",
                completionDate: "",
                tasks: [
                    { type: 'header', text: 'Treinamento' },
                    { type: 'task', text: 'Síndico, zelador e equipa de segurança.', checked: false },
                    { type: 'task', text: 'Uso do sistema, relatórios, abertura de chamados.', checked: false },
                    { type: 'header', text: 'Documentação' },
                    { type: 'task', text: 'Manual do sistema.', checked: false },
                    { type: 'task', text: 'Lista de senhas e acessos administrativos.', checked: false },
                    { type: 'task', text: 'Registo de configurações e IPs.', checked: false },
                    { type: 'header', text: 'Entrega oficial' },
                    { type: 'task', text: 'Assinatura de termo de entrega e aceitação.', checked: false },
                    { type: 'task', text: 'Início do suporte pós-implantação.', checked: false }
                ]
            }
        ];

        async function saveStateToFirestore() {
            if (!checklistDocRef) return;
            try {
                const dataToSave = { content: JSON.stringify(projectData) };
                await setDoc(checklistDocRef, dataToSave);
            } catch (error) {
                console.error("Erro ao guardar no Firestore: ", error);
            }
        }

        function renderAll() {
            condominiumNameElement.textContent = projectData.condominiumName;
            
            if (projectData.condominiumName === defaultCondominiumName) {
                condominiumNameElement.contentEditable = true;
                condominiumNameElement.classList.add('editable-field');
                condominiumNameElement.classList.remove('locked-field');
            } else {
                condominiumNameElement.contentEditable = false;
                condominiumNameElement.classList.remove('editable-field');
                condominiumNameElement.classList.add('locked-field');
            }

            renderChecklist();
        }

        function renderChecklist() {
            container.innerHTML = '';
            projectData.checklist.forEach((section, sectionIndex) => {
                const sectionElement = document.createElement('div');
                sectionElement.className = 'section-card p-6';
                let tasksHtml = '';
                section.tasks.forEach((task, taskIndex) => {
                    if (task.type === 'header') {
                        tasksHtml += `<div class="task-header">${task.text}</div>`;
                    } else {
                        tasksHtml += `
                            <div class="task-item flex items-center justify-between mb-3 group">
                                <div class="flex items-center flex-grow">
                                    <input type="checkbox" id="task-${sectionIndex}-${taskIndex}" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer flex-shrink-0" onchange="window.toggleTask(${sectionIndex}, ${taskIndex})" ${task.checked ? 'checked' : ''}>
                                    <span class="ml-3 text-gray-700 w-full" contenteditable="true" onblur="window.updateTaskText(${sectionIndex}, ${taskIndex}, this.innerText)">${task.text}</span>
                                </div>
                                <button onclick="window.deleteTask(${sectionIndex}, ${taskIndex})" class="delete-task-btn ml-4 text-gray-400 hover:text-red-500 flex-shrink-0">
                                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>`;
                    }
                });

                sectionElement.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">${section.title}</h2>
                    <div id="task-list-${sectionIndex}">${tasksHtml}</div>
                    
                    <div class="no-print mt-6 flex gap-3 border-t pt-6">
                        <input type="text" id="new-task-input-${sectionIndex}" class="flex-grow block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" placeholder="Adicionar novo passo...">
                        <button onclick="window.addTask(${sectionIndex})" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Adicionar</button>
                    </div>

                    <div class="mt-8 border-t pt-6">
                        <label for="obs-${sectionIndex}" class="block text-sm font-medium text-gray-700">Observações</label>
                        <textarea id="obs-${sectionIndex}" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-gray-50" onblur="window.updateObservation(${sectionIndex}, this.value)">${section.observations || ''}</textarea>
                    </div>
                    <div class="mt-4">
                        <label for="date-${sectionIndex}" class="block text-sm font-medium text-gray-700">Data de Conclusão</label>
                        <input type="date" id="date-${sectionIndex}" value="${section.completionDate || ''}" class="mt-1 block w-full sm:w-auto rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" onchange="window.updateCompletionDate(${sectionIndex}, this.value)">
                    </div>
                `;
                container.appendChild(sectionElement);
            });
            updateProgress();
        }
        
        window.updateObservation = function(sectionIndex, text) {
            if (projectData.checklist[sectionIndex].observations !== text) {
                projectData.checklist[sectionIndex].observations = text;
                saveStateToFirestore();
            }
        }

        window.updateCompletionDate = function(sectionIndex, date) {
             if (projectData.checklist[sectionIndex].completionDate !== date) {
                projectData.checklist[sectionIndex].completionDate = date;
                saveStateToFirestore();
            }
        }

        window.addTask = function(sectionIndex) {
            const input = document.getElementById(`new-task-input-${sectionIndex}`);
            const taskText = input.value.trim();
            if (taskText) {
                projectData.checklist[sectionIndex].tasks.push({ type: 'task', text: taskText, checked: false });
                saveStateToFirestore();
                input.value = '';
            }
        }
        
        // --- INÍCIO DA CORREÇÃO ---
        window.deleteTask = function(sectionIndex, taskIndex) {
            // Guarda os índices da tarefa a ser apagada
            taskToDelete = { sectionIndex, taskIndex };
            // Mostra o modal de confirmação
            deleteTaskModal.style.display = 'flex';
        }
        // --- FIM DA CORREÇÃO ---

        window.updateTaskText = function(sectionIndex, taskIndex, newText) {
            if (projectData.checklist[sectionIndex].tasks[taskIndex].text !== newText) {
                projectData.checklist[sectionIndex].tasks[taskIndex].text = newText;
                saveStateToFirestore();
            }
        }

        window.toggleTask = function(sectionIndex, taskIndex) {
            projectData.checklist[sectionIndex].tasks[taskIndex].checked = !projectData.checklist[sectionIndex].tasks[taskIndex].checked;
            saveStateToFirestore();
        }

        function updateProgress() {
            const allTasks = projectData.checklist.flatMap(section => section.tasks.filter(t => t.type === 'task'));
            const completedTasks = allTasks.filter(task => task.checked);
            const totalTasks = allTasks.length;
            const completedCount = completedTasks.length;
            const percentage = totalTasks > 0 ? Math.round((completedCount / totalTasks) * 100) : 0;
            progressBar.style.width = `${percentage}%`;
            progressPercentage.textContent = `${percentage}%`;

            if (percentage === 100) {
                pdfButton.style.display = 'inline-flex';
            } else {
                pdfButton.style.display = 'none';
            }
        }

        function generateId(length = 8) {
            return Math.random().toString(36).substring(2, 2 + length);
        }

        async function main() {
            if (!firebaseConfig.apiKey) {
                loadingOverlay.innerHTML = `<p class="text-center text-red-600 font-semibold p-4">Erro: A configuração do Firebase não foi encontrada.<br>Edite o ficheiro index.html e cole a sua 'firebaseConfig'.</p>`;
                return;
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Authentication failed:", error);
                loadingOverlay.innerHTML = "<p>Falha na autenticação.</p>";
                return;
            }
            
            let checklistId = window.location.hash.substring(1);
            if (!checklistId) {
                checklistId = generateId();
                window.location.hash = checklistId;
            }
            
            const shareLinkDisplay = document.getElementById('share-link-display');
            const copyLinkButton = document.getElementById('copy-link-button');
            if(shareLinkDisplay) {
                shareLinkDisplay.value = window.location.href;
                copyLinkButton.addEventListener('click', () => {
                    shareLinkDisplay.select();
                    document.execCommand('copy');
                    copyLinkButton.textContent = 'Copiado!';
                    setTimeout(() => { copyLinkButton.textContent = 'Copiar'; }, 2000);
                });
            }


            checklistDocRef = doc(db, "checklists", checklistId);
            
            unsubscribe = onSnapshot(checklistDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    projectData = JSON.parse(docSnap.data().content);
                } else {
                    console.log("Documento não encontrado, a criar um novo.");
                    projectData.checklist = JSON.parse(JSON.stringify(defaultChecklist));
                    saveStateToFirestore();
                }
                renderAll();
                loadingOverlay.style.opacity = '0';
                setTimeout(() => { 
                    if(loadingOverlay) loadingOverlay.style.display = 'none';
                }, 300);
            }, (error) => {
                console.error("Erro ao ouvir o documento do Firestore:", error);
                loadingOverlay.innerHTML = "<p>Erro ao carregar o checklist.</p>";
            });

            condominiumNameElement.addEventListener('blur', () => {
                const newName = condominiumNameElement.textContent.trim();
                if (projectData.condominiumName === defaultCondominiumName && newName && newName !== defaultCondominiumName) {
                    projectData.condominiumName = newName;
                    saveStateToFirestore();
                } else {
                    condominiumNameElement.textContent = projectData.condominiumName;
                }
            });
            
            // Abre o modal para apagar o cronograma
            resetButton.addEventListener('click', () => {
                passwordAction = 'delete';
                passwordModalTitle.textContent = 'Confirmar Exclusão';
                passwordModalText.textContent = 'Para apagar este cronograma, por favor, digite a senha de confirmação.';
                confirmActionButton.textContent = 'Confirmar Exclusão';
                confirmActionButton.className = 'px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm font-medium';
                
                passwordInput.value = '';
                passwordError.classList.add('hidden');
                passwordModal.style.display = 'flex';
            });

            // Abre o modal para criar um novo cronograma
            newChecklistButton.addEventListener('click', () => {
                passwordAction = 'createNew';
                passwordModalTitle.textContent = 'Criar Novo Cronograma';
                passwordModalText.textContent = 'Para criar um novo cronograma, por favor, digite a senha.';
                confirmActionButton.textContent = 'Confirmar Criação';
                confirmActionButton.className = 'px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium';

                passwordInput.value = '';
                passwordError.classList.add('hidden');
                passwordModal.style.display = 'flex';
            });

            // Fecha o modal de senha
            cancelActionButton.addEventListener('click', () => {
                passwordModal.style.display = 'none';
            });

            // Confirma a ação do modal de senha (apagar ou criar novo)
            confirmActionButton.addEventListener('click', async () => {
                if (passwordInput.value === 'mc3') {
                    passwordModal.style.display = 'none';

                    if (passwordAction === 'delete') {
                        if (unsubscribe) unsubscribe();
                        await deleteDoc(checklistDocRef);
                        window.location.reload();
                    } else if (passwordAction === 'createNew') {
                        window.location.href = window.location.origin + window.location.pathname;
                    }
                } else {
                    passwordError.classList.remove('hidden');
                }
            });
            
            // --- INÍCIO DA ADIÇÃO DOS EVENTOS DO NOVO MODAL ---
            // Fecha o modal de apagar tarefa
            cancelDeleteTaskButton.addEventListener('click', () => {
                deleteTaskModal.style.display = 'none';
                taskToDelete = null;
            });

            // Confirma a exclusão da tarefa
            confirmDeleteTaskButton.addEventListener('click', () => {
                if (taskToDelete) {
                    projectData.checklist[taskToDelete.sectionIndex].tasks.splice(taskToDelete.taskIndex, 1);
                    saveStateToFirestore();
                    taskToDelete = null;
                }
                deleteTaskModal.style.display = 'none';
            });
            // --- FIM DA ADIÇÃO DOS EVENTOS DO NOVO MODAL ---

            pdfButton.addEventListener('click', async () => {
                const originalButtonText = pdfButton.innerHTML;
                pdfButton.innerHTML = 'A gerar PDF...';
                pdfButton.disabled = true;

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: 'a4'
                });

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfMargin = 15;
                const contentWidth = pdfWidth - (pdfMargin * 2);
                let currentY = pdfMargin;

                const checkPageBreak = (elementHeight) => {
                    if (currentY + elementHeight > pdf.internal.pageSize.getHeight() - pdfMargin) {
                        pdf.addPage();
                        currentY = pdfMargin;
                    }
                };
                
                const logoImg = document.getElementById('logo-img');
                const logoRatio = logoImg.naturalWidth / logoImg.naturalHeight;
                const logoWidth = 80;
                const logoHeight = logoWidth / logoRatio;
                const logoX = (pdfWidth - logoWidth) / 2;
                pdf.addImage(logoImg, 'JPEG', logoX, currentY, logoWidth, logoHeight);
                currentY += logoHeight + 10;

                pdf.setFont('Helvetica', 'bold');
                pdf.setFontSize(20);
                pdf.text("Cronograma de Implantação", pdfWidth / 2, currentY, { align: 'center' });
                currentY += 10;
                
                pdf.setFont('Helvetica', 'normal');
                pdf.setFontSize(16);
                pdf.setTextColor(44, 82, 130);
                pdf.text(projectData.condominiumName, pdfWidth / 2, currentY, { align: 'center' });
                currentY += 15;
                pdf.setTextColor(0, 0, 0);

                projectData.checklist.forEach(section => {
                    checkPageBreak(20);
                    pdf.setFont('Helvetica', 'bold');
                    pdf.setFontSize(14);
                    pdf.text(section.title, pdfMargin, currentY);
                    currentY += 8;

                    pdf.setFont('Helvetica', 'normal');
                    pdf.setFontSize(10);
                    section.tasks.forEach(task => {
                        if (task.type === 'header') {
                            checkPageBreak(8);
                            pdf.setFont('Helvetica', 'bold');
                            pdf.text(task.text, pdfMargin + 5, currentY);
                            currentY += 7;
                            pdf.setFont('Helvetica', 'normal');
                        } else {
                            const symbol = task.checked ? '[X]' : '[ ]';
                            const lines = pdf.splitTextToSize(`${symbol} ${task.text}`, contentWidth - 5);
                            checkPageBreak(lines.length * 5);
                            pdf.text(lines, pdfMargin + 5, currentY);
                            currentY += (lines.length * 5);
                        }
                    });

                    if (section.observations) {
                        checkPageBreak(12);
                        pdf.setFont('Helvetica', 'bold');
                        pdf.text("Observações:", pdfMargin, currentY);
                        currentY += 5;
                        pdf.setFont('Helvetica', 'normal');
                        const obsLines = pdf.splitTextToSize(section.observations, contentWidth);
                        checkPageBreak(obsLines.length * 5);
                        pdf.text(obsLines, pdfMargin, currentY);
                        currentY += (obsLines.length * 5) + 5;
                    }

                    checkPageBreak(12);
                    pdf.setFont('Helvetica', 'bold');
                    pdf.text("Data de Conclusão:", pdfMargin, currentY);
                    pdf.setFont('Helvetica', 'normal');
                    const dateText = section.completionDate ? new Date(section.completionDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'Não definida';
                    pdf.text(dateText, pdfMargin + 40, currentY);
                    currentY += 15;
                });

                pdf.save(`Cronograma - ${projectData.condominiumName}.pdf`);

                pdfButton.innerHTML = originalButtonText;
                pdfButton.disabled = false;
            });
        }

        main();
    </script>
</body>
</html>
